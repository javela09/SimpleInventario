<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lector de C√≥digos de Barras</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1>üì¶ Lector de C√≥digos de Barras</h1>
            <div class="header-actions">
                <button id="btnExportar" class="btn btn-success">üì• Exportar CSV</button>
                <button id="btnLimpiarLecturas" class="btn btn-danger">üóëÔ∏è Limpiar Lecturas</button>
            </div>
        </header>

        <!-- Secci√≥n de escaneo -->
        <section class="scan-section">
            <div class="scan-input-container">
                <input type="text" 
                       id="inputEan" 
                       placeholder="Escanea o introduce el c√≥digo de barras..." 
                       autofocus
                       autocomplete="off">
                <button id="btnEscanear" class="btn btn-primary">Buscar</button>
            </div>
            
            <!-- Resultado de la √∫ltima lectura -->
            <div id="resultado" class="resultado" style="display: none;">
                <div class="resultado-content">
                    <span class="resultado-icon"></span>
                    <div class="resultado-text">
                        <p class="resultado-mensaje"></p>
                        <div class="resultado-detalle"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Gesti√≥n del maestro -->
        <section class="maestro-section">
            <div class="maestro-header">
                <h2>üìã Maestro de Art√≠culos</h2>
                <span id="contadorArticulos" class="contador">0 art√≠culos</span>
            </div>
            <div class="maestro-actions">
                <label class="btn btn-secondary file-input">
                    üì§ Importar Excel
                    <input type="file" id="archivoExcel" accept=".xlsx,.xls" hidden>
                </label>
                <button id="btnLimpiarMaestro" class="btn btn-outline">Limpiar Maestro</button>
            </div>
            <p class="maestro-info">Formato Excel: columnas <strong>C√≥digo Art√≠culo</strong>, <strong>Descripci√≥n</strong>, <strong>EAN</strong></p>
        </section>

        <!-- Lista de lecturas -->
        <section class="lecturas-section">
            <h2>üìù Lecturas Realizadas</h2>
            <div id="listaLecturas" class="lecturas-lista">
                <p class="empty-message">No hay lecturas todav√≠a</p>
            </div>
        </section>
    </div>

    <script>
        // Auto-focus en el input
        const inputEan = document.getElementById('inputEan');
        
        // Cargar datos al iniciar
        document.addEventListener('DOMContentLoaded', () => {
            cargarLecturas();
            cargarContadorArticulos();
            inputEan.focus();
        });

        // Escanear con Enter
        inputEan.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                escanear();
            }
        });

        // Bot√≥n escanear
        document.getElementById('btnEscanear').addEventListener('click', escanear);

        // Funci√≥n principal de escaneo
        async function escanear() {
            const ean = inputEan.value.trim();
            if (!ean) return;

            try {
                const response = await fetch('/api/escanear', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ean })
                });

                const data = await response.json();
                mostrarResultado(data, response.ok);

                if (response.ok) {
                    cargarLecturas();
                }
            } catch (error) {
                mostrarResultado({ success: false, message: 'Error de conexi√≥n' }, false);
            }

            inputEan.value = '';
            inputEan.focus();
        }

        // Mostrar resultado de escaneo
        function mostrarResultado(data, success) {
            const resultado = document.getElementById('resultado');
            const icon = resultado.querySelector('.resultado-icon');
            const mensaje = resultado.querySelector('.resultado-mensaje');
            const detalle = resultado.querySelector('.resultado-detalle');

            resultado.style.display = 'block';
            resultado.className = 'resultado ' + (success ? 'success' : 'error');

            if (success) {
                icon.textContent = '‚úÖ';
                mensaje.textContent = 'Art√≠culo encontrado y registrado';
                detalle.innerHTML = `
                    <div class="detalle-item"><strong>EAN:</strong> ${data.ean}</div>
                    <div class="detalle-item"><strong>C√≥digo:</strong> ${data.codigo_articulo}</div>
                    <div class="detalle-item"><strong>Descripci√≥n:</strong> ${data.descripcion}</div>
                `;
            } else {
                icon.textContent = '‚ùå';
                mensaje.textContent = data.message;
                detalle.innerHTML = '';
            }

            // Auto-ocultar despu√©s de 5 segundos
            setTimeout(() => {
                resultado.style.display = 'none';
            }, 5000);
        }

        // Cargar lista de lecturas
        async function cargarLecturas() {
            try {
                const response = await fetch('/api/lecturas');
                const lecturas = await response.json();

                const lista = document.getElementById('listaLecturas');

                if (lecturas.length === 0) {
                    lista.innerHTML = '<p class="empty-message">No hay lecturas todav√≠a</p>';
                    return;
                }

                lista.innerHTML = lecturas.map(l => `
                    <div class="lectura-item">
                        <div class="lectura-ean">${l.ean}</div>
                        <div class="lectura-codigo">${l.codigo_articulo}</div>
                        <div class="lectura-descripcion">${l.descripcion || '-'}</div>
                        <div class="lectura-fecha">${formatearFecha(l.fecha_lectura)}</div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error al cargar lecturas:', error);
            }
        }

        // Formatear fecha
        function formatearFecha(fecha) {
            if (!fecha) return '';
            const d = new Date(fecha);
            return d.toLocaleString('es-ES', { 
                day: '2-digit', 
                month: '2-digit', 
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Contador de art√≠culos
        async function cargarContadorArticulos() {
            try {
                const response = await fetch('/api/articulos/count');
                const data = await response.json();
                document.getElementById('contadorArticulos').textContent = `${data.count} art√≠culos`;
            } catch (error) {
                console.error('Error al contar art√≠culos:', error);
            }
        }

        // Importar Excel
        document.getElementById('archivoExcel').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('archivo', file);

            try {
                const response = await fetch('/api/articulos/importar', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                alert(data.message);
                cargarContadorArticulos();
            } catch (error) {
                alert('Error al importar archivo');
            }

            e.target.value = '';
        });

        // Limpiar maestro
        document.getElementById('btnLimpiarMaestro').addEventListener('click', async () => {
            if (!confirm('¬øEliminar todos los art√≠culos del maestro?')) return;

            try {
                await fetch('/api/articulos/limpiar', { method: 'DELETE' });
                cargarContadorArticulos();
                alert('Maestro limpiado');
            } catch (error) {
                alert('Error al limpiar');
            }
        });

        // Limpiar lecturas
        document.getElementById('btnLimpiarLecturas').addEventListener('click', async () => {
            if (!confirm('¬øEliminar todas las lecturas?')) return;

            try {
                await fetch('/api/lecturas/limpiar', { method: 'DELETE' });
                cargarLecturas();
                alert('Lecturas eliminadas');
            } catch (error) {
                alert('Error al limpiar');
            }
        });

        // Exportar CSV
        document.getElementById('btnExportar').addEventListener('click', () => {
            window.location.href = '/api/exportar';
        });

        // Mantener focus en el input
        document.addEventListener('click', (e) => {
            if (!e.target.closest('button') && !e.target.closest('input[type="file"]')) {
                inputEan.focus();
            }
        });
    </script>
</body>
</html>
